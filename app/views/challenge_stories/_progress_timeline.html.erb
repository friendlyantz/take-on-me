<%# Competitive Leaderboard with Progress Bars %>
<%= render "time_progress", challenge_story: challenge_story %>

<% if @participants.any? %>
  <% 
    # Calculate total days and max possible check-ins
    total_days = (Time.zone.today - challenge_story.start.to_date).to_i + 1
    total_days = [total_days, (challenge_story.finish - challenge_story.start).to_i + 1].min
    
    # Sort participants by check-ins for ranking
    ranked_participants = @participants.sort_by { |p| -p.challenge_comments_count }
  %>

  <div class="space-y-3 mb-6">
    <% ranked_participants.each_with_index do |participant, index| %>
      <% 
        check_ins = participant.challenge_comments_count
        completion_rate = total_days > 0 ? (check_ins.to_f / total_days * 100).round : 0
        latest_comment = participant.challenge_comments.order(created_at: :desc).limit(1).first
        
        # Rank styling
        rank_class = case index
          when 0 then "badge-warning"  # Gold
          when 1 then "badge-neutral"  # Silver
          when 2 then "badge-accent"   # Bronze
          else "badge-ghost"
        end
        
        progress_color = if completion_rate >= 90
          "progress-success"
        elsif completion_rate >= 70
          "progress-primary"
        elsif completion_rate >= 50
          "progress-warning"
        else
          "progress-error"
        end
      %>

      <div class="card bg-base-100 shadow-lg hover:shadow-xl transition-all border-2 <%= index == 0 ? 'border-warning' : 'border-base-300' %>">
        <div class="card-body p-4">
          <div class="flex items-center gap-4">
            <!-- Rank Badge -->
            <div class="flex-shrink-0">
              <div class="badge <%= rank_class %> badge-lg font-bold text-lg px-3 py-4">
                #<%= index + 1 %>
              </div>
            </div>

            <!-- Avatar -->
            <div class="avatar <%= index == 0 ? 'online' : '' %>">
              <div class="w-16 h-16 <%= index == 0 ? 'ring-4 ring-warning ring-offset-2' : 'ring-2 ring-base-300 ring-offset-1' %> rounded-full">
                <%= image_tag "https://api.dicebear.com/9.x/avataaars-neutral/svg?seed=#{participant.name}", 
                  class: "w-full h-full rounded-full object-cover", 
                  loading: "lazy" %>
              </div>
            </div>


            <!-- Progress Info -->
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-2">
                <h3 class="font-bold text-lg truncate"><%= participant.user.username %></h3>
                <% if index == 0 %>
                  <span class="badge badge-sm badge-warning gap-1">
                    ðŸ‘‘ Leader
                  </span>
                <% end %>
              </div>

              <!-- Progress Bar -->
              <div class="space-y-1">
                <div class="flex justify-between items-center text-xs font-semibold">
                  <span><%= check_ins %>/<%= total_days %> check-ins</span>
                  <span class="<%= completion_rate >= 80 ? 'text-success' : 'text-base-content/70' %>">
                    <%= completion_rate %>%
                  </span>
                </div>
                <progress class="progress <%= progress_color %> h-3" value="<%= completion_rate %>" max="100"></progress>
              </div>

              <!-- Latest Activity -->
              <% if latest_comment %>
                <div class="flex items-center gap-2 mt-2 text-xs opacity-70">
                  <svg class="h-3 w-3 text-success flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                  </svg>
                  <span class="truncate"><%= latest_comment.message.truncate(40) %></span>
                  <span class="text-base-content/50">Â· <%= time_ago_in_words(latest_comment.created_at) %> ago</span>
                </div>
              <% end %>
            </div>

            <!-- Stats Badge -->
            <div class="flex-shrink-0 text-center hidden sm:block">
              <div class="stat p-2">
                <div class="stat-value text-2xl <%= completion_rate >= 80 ? 'text-success' : 'text-primary' %>">
                  <%= completion_rate %>%
                </div>
                <div class="stat-desc text-xs">pace</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  </div>
<% else %>
  <%= render "challenge_stories/alerts/no_participants" %>
<% end %>
