<% if notice.present? %>
  <p class="py-2 px-3 bg-green-50 mb-5 text-green-500 font-medium rounded-md inline-block" id="notice">
    <%= notice %>
  </p>
<% end %>

<% 
  # Calculate total duration and elapsed time
  # move to ctrlr
  # probs a separate checkin object?
  total_duration = (challenge_story.finish - challenge_story.start).to_i
  elapsed_days = (Date.today - challenge_story.start).to_i
  progress_percentage = total_duration > 0 ? (elapsed_days.to_f / total_duration * 100).clamp(0, 100) : 0
  
  # Get recent comments (limited to 6 for our steps)
  recent_comments = challenge_story.challenge_comments.order(created_at: :asc).limit(6)
  
  # Determine challenge status
  status = if Date.today < challenge_story.start
             "upcoming"
           elsif Date.today > challenge_story.finish
             "completed"
           else
             "active"
           end
%>

<div class="flex flex-col mb-6">
  <div class="text-sm font-medium mb-2">Time: <%= progress_percentage.round %>% Complete</div>
  <progress class="progress progress-primary w-full" value="<%= progress_percentage %>" max="100"></progress>
</div>

<% participants = challenge_story.active_participants.includes(:user, :challenge_comments).order(created_at: :asc) %>
<% symbols = ["?", "!", "✓", "✕", "★", "⚡️"] %>

<% participants.each do |participant| %>
  <div class="mb-6">
    <div class="text-sm font-semibold mb-2 flex items-center gap-2">
      <span class="badge badge-primary"><%= participant.user.username %></span>
      <span class="text-xs opacity-70">joined <%= participant.created_at.strftime("%b %d") %></span>
    </div>
    
    <ul class="steps steps-vertical lg:steps">
      <li data-content="●" class="step step-success">
        <%= challenge_story.start.strftime("%b %d") %>
      </li>

      <% participant_comments = participant.challenge_comments.order(created_at: :asc) %>
      <% if participant_comments.any? %>
        <% participant_comments.each_with_index do |comment, index| %>
          <li data-content="<%= symbols[index % symbols.size] %>" class="step step-info">
            <span class="text-sm font-medium" title="<%= comment.message %>">
              <%= comment.message.truncate(25) %>
              <span class="text-xs opacity-70">(<%= comment.created_at.strftime("%b %d") %>)</span>
            </span>
          </li>
        <% end %>
      <% else %>
        <li data-content="?" class="step step-neutral">
          <span class="text-sm opacity-50">No check-ins yet</span>
        </li>
      <% end %>

      <li data-content="●" class="step <%= status == 'completed' ? 'step-success' : 'step-neutral' %>">
        <%= challenge_story.finish.strftime("%b %d") %>
      </li>
    </ul>
  </div>
<% end %>

<% if participants.empty? %>
  <div class="alert alert-info">
    <span>No participants yet. Be the first to join this challenge!</span>
  </div>
<% end %>

<div class="flex justify-between items-center mt-4 text-sm">
  <span class="badge badge-<%= {"upcoming" => "warning", "active" => "success", "completed" => "info"}[status] %>">
    <%= status.capitalize %> Challenge
  </span>
  <span class="opacity-70">
    <%= total_duration %> days total
    <% if status == "active" %>
      (<%= (challenge_story.finish - Date.today).to_i %> days remaining)
    <% end %>
  </span>
</div>
