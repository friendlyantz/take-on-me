<%# TODO: cleanup, optimise or remove %>
<%= render "time_progress", challenge_story: challenge_story %>


<% if @participants.any? %>
  <div class="space-y-4 mb-6">
    <% @participants.each do |participant| %>
      <div class="card bg-base-100 shadow-lg">
        <div class="card-body p-4">
          <div class="flex items-center gap-3 mb-3">
            <div class="avatar placeholder">
              <div class="bg-neutral text-neutral-content rounded-full w-10">
                <%= image_tag "https://api.dicebear.com/9.x/avataaars-neutral/svg?seed=#{participant.name}&options[skinColor]=random&size=80", 
                    class: "rounded-full" %>
              </div>
            </div>
            <div class="flex-1">
              <div class="font-semibold"><%= participant.user.username %></div>
              <div class="text-xs opacity-70">Joined <%= participant.created_at.to_fs(:short) %></div>
            </div>
            <div class="badge badge-ghost">
              <%= participant.challenge_comments_count %> check-ins
            </div>
          </div>

          <% participant_comments = participant.challenge_comments.order(created_at: :desc).limit(3) %>

          <% if participant_comments.any? %>
            <div class="space-y-2">
              <%# TODO: fix N+1 %>
              <% participant_comments.each do |comment| %>
                <div class="flex items-start gap-2 text-sm">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-success mt-0.5 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                  <div class="flex-1 min-w-0">
                    <p class="truncate"><%= comment.message %></p>
                    <p class="text-xs opacity-60"><%= comment.created_at.to_fs(:short) %></p>
                  </div>
                </div>
              <% end %>
              <% if participant.challenge_comments_count > 3 %>
                <div class="text-xs text-center opacity-70 pt-1">
                  + <%= participant.challenge_comments_count - 3 %> more check-ins
                </div>
              <% end %>
            </div>
          <% else %>
            <div class="text-sm opacity-50 italic text-center py-2">
              No check-ins yet
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
<% else %>
  <%= render "challenge_stories/alerts/no_participants" %>
<% end %>
