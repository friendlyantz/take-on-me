<% content_for :title, @challenge_story.title %>
<div class="md:w-2/3 w-full">

  <div class="flex justify-between items-center mb-6">
    <%= link_to challenge_stories_path, class: "btn btn-outline btn-sm items-center gap-2", "data-turbo-frame": "_top" do %>
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
      </svg>
      Back
    <% end %>

    <div class="flex items-center gap-2">
      <span class="text-sm opacity-70">Like this challenge:</span>
      <%= render 'challenge_stories/likes', challenge_story: @challenge_story %>
    </div>
  </div>

  <%= render @challenge_story %>

  <% if current_user %>
    <div class="flex gap-2 mb-4">
      <%= link_to "Edit", edit_challenge_story_path(@challenge_story), class: "btn btn-soft btn-primary" %>
      
      <% unless @challenge_story.completed? %>
        <%= button_to "Mark as Complete", complete_challenge_story_path(@challenge_story), 
            method: :patch, 
            class: "btn btn-success",
            data: { turbo_confirm: "Are you sure you want to mark this challenge as complete?" } %>
      <% else %>
        <span class="badge badge-success badge-lg">âœ“ Completed</span>
      <% end %>
    </div>
      <% end %>

  <%= render "rewards_section", challenge_story: @challenge_story %>

  <%= turbo_stream_from @challenge_story %>
  <%= turbo_frame_tag "challenge_story" do %>
    <%= render "progress_timeline", challenge_story: @challenge_story %>
  <% end %>



  <% if current_user %>
    <% unless @challenge_story.completed? %>
      <%= turbo_frame_tag "new_message", src: new_challenge_story_challenge_comment_path(@challenge_story), target: "_top" %>
    <% else %>
      <div class="alert alert-info mt-4">
        <span>This challenge is complete. No more check-ins can be added.</span>
      </div>
    <% end %>
  <% else %>
    <%= link_to new_session_path, class: "btn btn-secondary" do %>
      Sign in to join this challenge
    <% end %>
  <% end %>

  <div id="challenge_comments" class="w-full sm:w-auto my-5 space-y-5">
    <%= render @challenge_story.challenge_comments.reverse %>
  </div>

</div>