<% content_for :title, @challenge_story.title %>
<div class="md:w-2/3 w-full">

  <div class="flex justify-between items-center mb-6">
    <%= link_to challenge_stories_path, class: "btn btn-outline btn-sm items-center gap-2", "data-turbo-frame": "_top" do %>
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
      </svg>
      Back
    <% end %>

    <div class="flex items-center gap-3">
      <% if current_user %>
        <%= link_to "Edit", edit_challenge_story_path(@challenge_story), class: "btn btn-sm btn-ghost" %>

        <% unless @challenge_story.completed? %>
          <%= button_to "Mark Complete", complete_challenge_story_path(@challenge_story), 
              method: :patch, 
              class: "btn btn-sm btn-success",
              data: { turbo_confirm: "Are you sure you want to mark this challenge as complete?" } %>
        <% end %>
      <% end %>

      <%= render 'challenge_stories/likes', challenge_story: @challenge_story %>
    </div>
  </div>

  <%= render @challenge_story %>

  <%= render "rewards_section", challenge_story: @challenge_story %>

  <%= turbo_stream_from @challenge_story %>
  <%= turbo_frame_tag "challenge_story" do %>
    <%= render "progress_timeline", challenge_story: @challenge_story %>
  <% end %>


  <% if current_user %>
    <% if @current_participant&.active? %>
      <% unless @challenge_story.completed? %>
        <% if @today_comment %>
          <div class="alert alert-success shadow-lg mb-6">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>You've already checked in today. Come back tomorrow!</span>
          </div>
        <% else %>
          <%= turbo_frame_tag "new_message", src: new_challenge_story_challenge_comment_path(@challenge_story) %>
        <% end %>
      <% else %>
        <div class="alert alert-info shadow-lg mb-6">
          <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <span>This challenge is complete. No more check-ins can be added.</span>
        </div>
      <% end %>
    <% else %>
      <div class="card bg-warning/10 border border-warning shadow-lg mb-6">
        <div class="card-body">
          <div class="flex items-start gap-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-warning shrink-0 h-8 w-8 mt-1" fill="none" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <div class="flex-1">
              <h3 class="font-semibold text-lg mb-2">Join this challenge to check in</h3>
              <p class="text-sm opacity-70 mb-4">You must be a participant to track your progress and check in daily.</p>
              <% if @challenge_story.at_capacity? %>
                <div class="alert alert-error">
                  <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-5 w-5" fill="none" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <span>Challenge is at capacity (max <%= ChallengeStory::MAX_PARTICIPANTS %> participants)</span>
                </div>
              <% else %>
                <%= link_to challenge_participants_path(challenge_story_id: @challenge_story.id), data: { turbo_method: :post } do %>
                  <turbo-frame id="story-<%= @challenge_story.id %>-joining_participant">
                    <button class="btn btn-warning gap-2">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                      </svg>
                      Join Challenge
                      <div class="badge badge-sm bg-warning-content/20"><%= @challenge_story.available_spots %> <%= 'spot'.pluralize(@challenge_story.available_spots) %> left</div>
                    </button>
                  </turbo-frame>
                <% end %>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  <% else %>
    <div class="card bg-base-200 shadow-lg mb-6">
      <div class="card-body text-center">
        <h3 class="card-title justify-center">Want to join this challenge?</h3>
        <p class="opacity-70">Sign in to start tracking your progress</p>
        <%= link_to "Sign In", new_session_path, class: "btn btn-primary" %>
      </div>
    </div>
  <% end %>

  <div class="divider">Check-ins</div>

  <div id="challenge_comments" class="w-full sm:w-auto my-5 space-y-5">
    <%= render @challenge_story.challenge_comments.reverse %>
  </div>

</div>