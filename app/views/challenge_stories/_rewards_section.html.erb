<div class="card bg-base-100 shadow-lg mt-8">
  <div class="card-body">
    <h2 class="card-title flex items-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-warning" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a4 4 0 112.76 3.77c.08-.65.14-1.3.14-1.97A4.82 4.82 0 008.47 4.22a4.83 4.83 0 00-6.71 6.86C2.87 14 5.31 17.2 9.09 19.38c.06.04.12.07.18.1l.05.03c.46.25 1.01.42 1.6.52.01 0 .01 0 .02.01.49.09 1 .14 1.54.14.56 0 1.11-.06 1.64-.17l.02-.01c.67-.14 1.28-.35 1.83-.66l.06-.03a9.72 9.72 0 002.42-1.84c1.54-1.6 2.46-3.8 2.46-6.6 0-.08 0-.16-.01-.24-.01-.2-.03-.4-.05-.6-.16-1.25-.58-2.4-1.22-3.39A4.83 4.83 0 0014.76 4c-2.64 0-4.78 2.14-4.78 4.78 0 1.04.33 2.29 1.01 3.24" />
      </svg>
      Rewards & Bets
    </h2>

    <p class="text-sm opacity-70 mt-1">
      Pledge rewards to motivate your friends or bet on challenge outcomes!
      <% if challenge_story.finished? %>
        <span class="font-semibold">This challenge is complete - time to fulfill your promises!</span>
      <% end %>
    </p>

    <div class="stats shadow mt-4 bg-base-200">
      <div class="stat">
        <div class="stat-figure text-primary">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
        </div>
        <div class="stat-title">Total Rewards</div>
        <div class="stat-value text-primary"><%= challenge_story.challenge_rewards.count %></div>
        <div class="stat-desc">All rewards pledged in this challenge</div>
      </div>

      <div class="stat">
        <div class="stat-figure text-secondary">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
        </div>
        <div class="stat-title">For You</div>
        <div class="stat-value text-secondary">
          <%= challenge_story.challenge_rewards.select { |r| r.receiver&.user == current_user }.count %>
        </div>
        <div class="stat-desc">Rewards pledged to you</div>
      </div>
    </div>

    <div class="card-actions justify-end mt-4">
      <%= link_to challenge_story_challenge_rewards_path(challenge_story), class: "btn btn-outline" do %>
        View all rewards 
        <div class="badge badge-secondary ml-2">
          <%= challenge_story.challenge_rewards.count %>
        </div>
      <% end %>

      <% if challenge_story.active_participants.exists?(user: current_user) %>
        <%= link_to new_challenge_story_challenge_reward_path(challenge_story), class: "btn btn-primary" do %>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          Pledge a reward
        <% end %>
      <% elsif current_user %>
        <% if challenge_story.at_capacity? %>
          <div class="tooltip tooltip-left" data-tip="Challenge is full (max <%= ChallengeStory::MAX_PARTICIPANTS %> participants)">
            <button class="btn btn-disabled" disabled>Challenge Full</button>
          </div>
        <% else %>
          <%= link_to challenge_participants_path(challenge_story_id: challenge_story.id), method: :post, turbo: true do %>
            <div class="card-actions justify-end">
              <turbo-frame id="story-<%= challenge_story.id %>-joining_participant">
                <button class="btn btn-primary">
                  Join (<%= challenge_story.available_spots %> spot<%= challenge_story.available_spots == 1 ? '' : 's' %> left)
                </button>
              </turbo-frame >
            </div>
          <% end %>
        <% end %>

      <% else %>
        <%= link_to new_session_path, class: "btn btn-secondary" do %>
          Sign in to join this challenge
        <% end %>
      <% end %>
    </div>
  </div>
</div>
